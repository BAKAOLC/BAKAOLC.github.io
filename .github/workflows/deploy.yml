name: Deploy to GitHub Pages

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        permissions:
            contents: read
            pages: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Restore thumbnail cache file
              uses: actions/cache/restore@v4
              id: cache-thumbnail-cache
              with:
                  path: .thumbnail-cache.json
                  key: thumbnail-cache-v2-${{ hashFiles('public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}
                  restore-keys: |
                      thumbnail-cache-v2-
                      thumbnail-cache-

            - name: Restore generated thumbnails
              uses: actions/cache/restore@v4
              id: cache-thumbnails
              with:
                  path: public/assets/thumbnails
                  key: thumbnails-v2-${{ hashFiles('scripts/generate-thumbnails.cjs', 'public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}
                  restore-keys: |
                      thumbnails-v2-
                      thumbnails-v1-
                      thumbnails-

            - name: Install dependencies
              run: npm ci

            - name: Check cache status
              run: |
                  echo "=== 缓存状态检查 ==="
                  echo "缩略图缓存命中: ${{ steps.cache-thumbnails.outputs.cache-hit }}"
                  echo "缓存文件命中: ${{ steps.cache-thumbnail-cache.outputs.cache-hit }}"
                  echo "缩略图缓存键: thumbnails-v2-${{ hashFiles('scripts/generate-thumbnails.cjs', 'public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}"
                  echo "缓存文件键: thumbnail-cache-v2-${{ hashFiles('public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}"

                  if [ -d "public/assets/thumbnails" ]; then
                    echo "缩略图目录存在，包含 $(find public/assets/thumbnails -type f | wc -l) 个文件"
                    echo "缩略图目录大小: $(du -sh public/assets/thumbnails 2>/dev/null || echo '0')"
                  else
                    echo "缩略图目录不存在"
                  fi

                  if [ -f ".thumbnail-cache.json" ]; then
                    echo "缓存文件存在，包含 $(wc -l < .thumbnail-cache.json) 行"
                    echo "缓存文件大小: $(du -sh .thumbnail-cache.json 2>/dev/null || echo '0')"
                  else
                    echo "缓存文件不存在"
                  fi

                  echo "源图片文件哈希: ${{ hashFiles('public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}"
                  echo "脚本文件哈希: ${{ hashFiles('scripts/generate-thumbnails.cjs') }}"

            - name: Create thumbnails directory if not exists
              run: mkdir -p public/assets/thumbnails

            - name: Generate thumbnails (with incremental update)
              run: npm run generate-thumbnails

            - name: Check if new cache was generated
              id: check-cache-changes
              run: |
                  echo "=== 检查缓存变化 ==="

                  # 检查缩略图缓存是否需要更新
                  if [ "${{ steps.cache-thumbnail-cache.outputs.cache-hit }}" = "true" ]; then
                    echo "缩略图缓存文件命中，检查是否有变化..."
                    echo "thumbnail-cache-needs-save=false" >> $GITHUB_OUTPUT
                  else
                    echo "缩略图缓存文件未命中，需要保存"
                    echo "thumbnail-cache-needs-save=true" >> $GITHUB_OUTPUT
                  fi

                  # 检查缩略图文件是否需要更新
                  if [ "${{ steps.cache-thumbnails.outputs.cache-hit }}" = "true" ]; then
                    echo "缩略图文件缓存命中，检查是否有变化..."
                    echo "thumbnails-needs-save=false" >> $GITHUB_OUTPUT
                  else
                    echo "缩略图文件缓存未命中，需要保存"
                    echo "thumbnails-needs-save=true" >> $GITHUB_OUTPUT
                  fi

                  echo "缓存决策已完成，将在后续步骤中应用"

            - name: Build
              run: npm run build

            - name: Save thumbnail cache file
              uses: actions/cache/save@v4
              if: github.event_name == 'push' && steps.check-cache-changes.outputs.thumbnail-cache-needs-save == 'true'
              with:
                  path: .thumbnail-cache.json
                  key: thumbnail-cache-v2-${{ hashFiles('public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}

            - name: Save generated thumbnails
              uses: actions/cache/save@v4
              if: github.event_name == 'push' && steps.check-cache-changes.outputs.thumbnails-needs-save == 'true'
              with:
                  path: public/assets/thumbnails
                  key: thumbnails-v2-${{ hashFiles('scripts/generate-thumbnails.cjs', 'public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}

            - name: Verify cache save
              if: github.event_name == 'push'
              run: |
                  echo "=== 缓存保存确认 ==="
                  echo "当前构建完成，缓存状态："

                  # 检查缓存文件状态
                  if [ -f ".thumbnail-cache.json" ]; then
                    echo "✅ 缓存文件已生成: $(wc -l < .thumbnail-cache.json) 行"
                    if [ "${{ steps.check-cache-changes.outputs.thumbnail-cache-needs-save }}" = "true" ]; then
                      echo "📤 缓存文件已上传到 GitHub Actions 缓存"
                    else
                      echo "⏭️  缓存文件未变化，跳过上传"
                    fi
                  else
                    echo "❌ 缓存文件未生成"
                  fi

                  # 检查缩略图状态
                  if [ -d "public/assets/thumbnails" ] && [ "$(find public/assets/thumbnails -type f | wc -l)" -gt 0 ]; then
                    echo "✅ 缩略图已生成: $(find public/assets/thumbnails -type f | wc -l) 个文件"
                    if [ "${{ steps.check-cache-changes.outputs.thumbnails-needs-save }}" = "true" ]; then
                      echo "📤 缩略图已上传到 GitHub Actions 缓存"
                    else
                      echo "⏭️  缩略图未变化，跳过上传"
                    fi
                  else
                    echo "❌ 缩略图未生成或为空"
                  fi

                  echo ""
                  echo "=== 缓存决策摘要 ==="
                  echo "缩略图缓存文件上传: ${{ steps.check-cache-changes.outputs.thumbnail-cache-needs-save }}"
                  echo "缩略图文件上传: ${{ steps.check-cache-changes.outputs.thumbnails-needs-save }}"

            - name: Setup Pages
              if: github.event_name == 'push'
              uses: actions/configure-pages@v4

            - name: Upload artifact
              if: github.event_name == 'push'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./dist

            - name: Deploy to GitHub Pages
              if: github.event_name == 'push'
              id: deployment
              uses: actions/deploy-pages@v4
